<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <title>Local Storage Test Site</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

        <style>
            body {
                font-family: sans-serif;
            }
        </style>
    </head>
    <script>
      const valuesMap = new Map();

      class LocalStorage {
        getItem (key) {
          const stringKey = String(key)
          if (valuesMap.has(key)) {
            return String(valuesMap.get(stringKey))
          }
          return null
        }

        setItem (key, val) {
          valuesMap.set(String(key), String(val))
        }

        removeItem (key) {
          valuesMap.delete(key)
        }

        clear () {
          valuesMap.clear()
        }

        key (i) {
          if (arguments.length === 0) {
            throw new TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.") // this is a TypeError implemented on Chrome, Firefox throws Not enough arguments to Storage.key.
          }
          var arr = Array.from(valuesMap.keys())
          return arr[i]
        }

        get length () {
          return valuesMap.size
        }
      }
      const instance = new LocalStorage()

      localStorage = new Proxy(instance, {
        set: function (obj, prop, value) {
          if (LocalStorage.prototype.hasOwnProperty(prop)) {
            instance[prop] = value
          } else {
            instance.setItem(prop, value)
          }
          return true
        },
        get: function (target, name) {
          if (LocalStorage.prototype.hasOwnProperty(name)) {
            return instance[name]
          }
          if (valuesMap.has(name)) {
            return instance.getItem(name)
          }
        }
      });
    </script>

    <body>
        <h3>Local Storage Test</h3>
        <div id="debug" />

        <script>
          const debug = document.getElementById('debug');
          const addDebugMsg = (str) => {
            debug.insertAdjacentHTML('afterbegin', str + '<br />');
          };
          window.onerror = function(message, source, line, col) {
            addDebugMsg(message + ' ' + source + ' ' + line + ' ' + col);
          };
        </script>

        <script type="application/javascript">
            localStorage.setItem('test', 'test value');
            const test = localStorage.getItem('test');
            addDebugMsg('Local Storage value: ' + test);
            localStorage.removeItem('test');
        </script>
    </body>
</html>
